"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=true;exports.default=void 0;var _inheritsLoose2=_interopRequireDefault(require("@babel/runtime/helpers/inheritsLoose"));var _componentInterface=require("@fusioncharts/core/src/component-interface");var _polarUtil=require("@fusioncharts/utils/src/scale-utils/polar-util");var _utils=require("../../chart/chord/utils");var _lib=require("@fusioncharts/core/src/lib");var _pieLabelUtils=require("@fusioncharts/charts/src/dataset/pie2d/pie-label-utils");var nodeGenerator=function nodeGenerator(_startAngle,_endAngle,arc,outerRadius,innerRadius){var startAngle=(0,_utils.normaliseAngle)(_startAngle),endAngle=(0,_utils.normaliseAngle)(_endAngle),_polarToCartesian=(0,_polarUtil.polarToCartesian)(outerRadius,startAngle,false),x1=_polarToCartesian.x,y1=_polarToCartesian.y,_polarToCartesian2=(0,_polarUtil.polarToCartesian)(outerRadius,endAngle,false),x2=_polarToCartesian2.x,y2=_polarToCartesian2.y,_polarToCartesian3=(0,_polarUtil.polarToCartesian)(innerRadius,startAngle,false),x3=_polarToCartesian3.x,y3=_polarToCartesian3.y,_polarToCartesian4=(0,_polarUtil.polarToCartesian)(innerRadius,endAngle,false),x4=_polarToCartesian4.x,y4=_polarToCartesian4.y;x1=(0,_lib.toPrecision)(x1,4);y1=(0,_lib.toPrecision)(y1,4);x2=(0,_lib.toPrecision)(x2,4);y2=(0,_lib.toPrecision)(y2,4);x3=(0,_lib.toPrecision)(x3,4);y3=(0,_lib.toPrecision)(y3,4);x4=(0,_lib.toPrecision)(x4,4);y4=(0,_lib.toPrecision)(y4,4);return[_utils.M,x1,y1,_utils.A,outerRadius,outerRadius,0,arc>180?1:0,1,x2,y2,_utils.L,x4,y4,_utils.A,innerRadius,innerRadius,0,arc>180?1:0,0,x3,y3,_utils.Z]},labelPathGenerator=function labelPathGenerator(_startAngle,_endAngle,arc,radius){var _polarToCartesian5=(0,_polarUtil.polarToCartesian)(radius,(0,_utils.normaliseAngle)(_startAngle),false),x1=_polarToCartesian5.x,y1=_polarToCartesian5.y,_polarToCartesian6=(0,_polarUtil.polarToCartesian)(radius,(0,_utils.normaliseAngle)(_endAngle),false),x2=_polarToCartesian6.x,y2=_polarToCartesian6.y;return"M "+x1+" "+y1+" A "+radius+" "+radius+" "+0+" "+(arc>180?1:0)+" "+(_startAngle>_endAngle?0:1)+" "+x2+" "+y2},RED="#ff0000",LABEL_POSITION_TANGENTIAL="tangential",LABEL_POSITION_OUTSIDE="outside",LABEL_POSITION_INSIDE="inside",START="start",PADDING=4,clickFn=function clickFn(){var node=this,manager=node.getLinkedParent(),legend=node.getFromEnv("legend"),legendItem=legend?legend.getItem(manager.config.legendItemMap[node.config.label]):null;manager.nodeClicked(node.config.label,legendItem)},END="end",mouseOverFn=function mouseOverFn(){this.getLinkedParent().nodeHoverIn(this.config.label)},mouseOutFn=function mouseOutFn(){this.getLinkedParent().nodeHoverOut(this.config.label)},getTooltext=function getTooltext(config,basefontsize){var uniChar=_lib.isIpad?_utils.SMALLSQUARE:_utils.MEDIUMSQUARE;return"<div style='padding: 2px; vertical-align: middle; font-size: "+basefontsize+"px;'>\n        <span style='color: "+config.color+";'>\n            "+uniChar+"\n        </span>\n        "+(config.label+config.toolTipSepChar)+"\n        &nbsp;\n        "+config.formattedValue+"\n      </div>"};var Node=function(_SmartRenderer){(0,_inheritsLoose2.default)(Node,_SmartRenderer);function Node(id){var _this;_this=_SmartRenderer.call(this,id)||this;_this.addEventListener("fc-click",clickFn);_this.addEventListener("fc-mouseover",mouseOverFn);_this.addEventListener("fc-mouseout",mouseOutFn);return _this}var _proto=Node.prototype;_proto.__setDefaultConfig=function __setDefaultConfig(){_SmartRenderer.prototype.__setDefaultConfig.call(this);var config=this.config;config.styles={fill:RED,stroke:RED,"fill-alpha":.7}};_proto.configureAttributes=function configureAttributes(dataObj){_SmartRenderer.prototype.configureAttributes.call(this,dataObj);Object.assign(this.config,dataObj);var node=this;node.config.formattedValue=node.getFromEnv("number-formatter").dataLabels(node.config.total)};_proto.setDimension=function setDimension(dim){Object.assign(this.config,dim)};_proto.allocatePosition=function allocatePosition(){var node=this,config=node.config,label=config.label,_node$getFromEnv=node.getFromEnv("chartConfig"),canvasHeight=_node$getFromEnv.canvasHeight,canvasWidth=_node$getFromEnv.canvasWidth,cx=_node$getFromEnv.cx,cy=_node$getFromEnv.cy,slope,labelOrientation=config.labelPosition,applicableRadius=config.outerRadius+config.nodeLabelGap,smartLabel=node.getFromEnv("smartLabel"),startingAngle=(0,_utils.normaliseAngle)(config.startingAngle),endingAngle=(0,_utils.normaliseAngle)(config.endingAngle),labelAttrs={},smartLabelOutput,lineHeight,labelCatersianPosition;lineHeight=(0,_lib.setLineHeight)({fontSize:config.style["font-size"]}).replace(/px/gi,_lib.BLANKSTRING);smartLabel.setStyle(config.style);smartLabel.useEllipsesOnOverflow(node.getFromEnv("chartConfig").useEllipsesOnOverflow);switch(labelOrientation){case LABEL_POSITION_TANGENTIAL:{var labelAngleCenter=(startingAngle+endingAngle)/2%360,x2,y2,spaceRemaining=0;labelCatersianPosition=(0,_polarUtil.polarToCartesian)(applicableRadius,labelAngleCenter,false);var quadrant=(0,_pieLabelUtils.getQuadrant)((0,_polarUtil.deg2Rad)(labelAngleCenter));switch(quadrant){case 0:x2=canvasWidth/2;y2=canvasHeight/2;slope=Math.tan((0,_polarUtil.deg2Rad)(360-labelAngleCenter));if(Math.abs(x2*slope)<=y2){spaceRemaining=(0,_utils.getCartesianDistance)(labelCatersianPosition.x+cx,labelCatersianPosition.y+cy,cx+x2,cy-x2*slope)}else{spaceRemaining=(0,_utils.getCartesianDistance)(labelCatersianPosition.x+cx,labelCatersianPosition.y+cy,cx-y2/slope,cy+y2)}break;case 1:x2=-1*canvasWidth/2;y2=canvasHeight/2;slope=Math.tan((0,_polarUtil.deg2Rad)(180+labelAngleCenter));if(Math.abs(x2*slope)<=Math.abs(y2)){spaceRemaining=(0,_utils.getCartesianDistance)(labelCatersianPosition.x+cx,labelCatersianPosition.y+cy,cx+x2,cy+x2*slope)}else{spaceRemaining=(0,_utils.getCartesianDistance)(labelCatersianPosition.x+cx,labelCatersianPosition.y+cy,cx+y2/slope,cy+y2)}break;case 2:x2=-1*canvasWidth/2;y2=-1*(canvasHeight/2);slope=Math.tan((0,_polarUtil.deg2Rad)(360-labelAngleCenter));if(Math.abs(x2*slope)<=Math.abs(y2)){spaceRemaining=(0,_utils.getCartesianDistance)(labelCatersianPosition.x+cx,labelCatersianPosition.y+cy,cx+x2,cy-x2*slope)}else{spaceRemaining=(0,_utils.getCartesianDistance)(labelCatersianPosition.x+cx,labelCatersianPosition.y+cy,cx-y2/slope,cy+y2)}break;case 3:x2=canvasWidth/2;y2=-1*(canvasHeight/2);slope=Math.tan((0,_polarUtil.deg2Rad)(-1*labelAngleCenter));if(Math.abs(x2*slope)<=Math.abs(y2)){spaceRemaining=(0,_utils.getCartesianDistance)(labelCatersianPosition.x+cx,labelCatersianPosition.y+cy,cx+x2,cy-x2*slope)}else{spaceRemaining=(0,_utils.getCartesianDistance)(labelCatersianPosition.x+cx,labelCatersianPosition.y+cy,cx-y2/slope,cy+y2)}break;default:;}smartLabelOutput=smartLabel.getSmartText(label,spaceRemaining,lineHeight);labelAttrs.transform=(0,_lib.getSuggestiveRotation)((0,_utils.getTextRotationByQuadrant)(labelAngleCenter),labelCatersianPosition.x,labelCatersianPosition.y);if((0,_utils.isAngleInLeftHemisphere)(labelAngleCenter)){labelAttrs["text-anchor"]=END}labelAttrs.x=labelCatersianPosition.x;labelAttrs.y=labelCatersianPosition.y;break}case LABEL_POSITION_OUTSIDE:{var labelAngleCenterDeg=(startingAngle+endingAngle)/2%360,labelAngleCenterRad=(0,_polarUtil.deg2Rad)(labelAngleCenterDeg),labelAngleCenterCleanRad=(0,_pieLabelUtils.getCleanAngle)(labelAngleCenterRad),labelAngleCenterCleanDeg=(0,_polarUtil.rad2Deg)(labelAngleCenterCleanRad),isLabelCenterInTopHemisphere=(0,_utils.isAngleInTopHemisphere)(labelAngleCenterCleanDeg),arcLength=(0,_utils.getArcLength)(applicableRadius,startingAngle,endingAngle),textPathStartAngle=isLabelCenterInTopHemisphere?config.startingAngle:config.endingAngle,textPathEndAngle=isLabelCenterInTopHemisphere?config.endingAngle:config.startingAngle;smartLabelOutput=smartLabel.getSmartText(label,arcLength-PADDING,lineHeight);if(_lib.isIE11){if(!isLabelCenterInTopHemisphere){applicableRadius+=smartLabelOutput.height*.7}}labelAttrs.textpath={path:labelPathGenerator(textPathStartAngle,textPathEndAngle,config.arcAngle,applicableRadius),startOffset:"50%"};labelAttrs[_lib.TEXTANCHOR]=_lib.MIDDLESTR;labelAttrs["vertical-align"]=isLabelCenterInTopHemisphere?"top":"bottom";labelAttrs.transform=null;labelAttrs.x=0;labelAttrs.y=0;break}case LABEL_POSITION_INSIDE:default:{var _labelAngleCenterDeg=(startingAngle+endingAngle)/2%360,_labelAngleCenterRad=(0,_polarUtil.deg2Rad)(_labelAngleCenterDeg),_labelAngleCenterCleanRad=(0,_pieLabelUtils.getCleanAngle)(_labelAngleCenterRad),_labelAngleCenterCleanDeg=(0,_polarUtil.rad2Deg)(_labelAngleCenterCleanRad),_isLabelCenterInTopHemisphere=(0,_utils.isAngleInTopHemisphere)(_labelAngleCenterCleanDeg),middleRadius=(config.outerRadius+config.innerRadius)/2,_arcLength=(0,_utils.getArcLength)(middleRadius,startingAngle,endingAngle),_textPathStartAngle=_isLabelCenterInTopHemisphere?config.startingAngle:config.endingAngle,_textPathEndAngle=_isLabelCenterInTopHemisphere?config.endingAngle:config.startingAngle;smartLabelOutput=smartLabel.getSmartText(label,_arcLength-PADDING,lineHeight);if(_lib.isIE11){if(_isLabelCenterInTopHemisphere){middleRadius-=smartLabelOutput.height*.3}else{middleRadius+=smartLabelOutput.height*.3}}labelAttrs.textpath={path:labelPathGenerator(_textPathStartAngle,_textPathEndAngle,config.arcAngle,middleRadius),startOffset:"50%"};labelAttrs[_lib.TEXTANCHOR]=_lib.MIDDLESTR;labelAttrs["vertical-align"]=_lib.MIDDLESTR;labelAttrs.transform=null;labelAttrs.x=0;labelAttrs.y=0;break}}labelAttrs.fill=(0,_lib.convertColor)(config.labelColor,100);labelAttrs.text=smartLabelOutput.text;labelAttrs.cursor=_lib.POINTER;labelAttrs["text-anchor"]=labelAttrs["text-anchor"]||START;node.config.labelAttrs=labelAttrs;node.config.path=nodeGenerator(config.startingAngle,config.endingAngle,config.arcAngle,config.outerRadius,config.innerRadius);node.config.focussedState.path=node.config.path;node.config.normalState.path=node.config.path;node.config.unfocussedState.path=node.config.path;node.config.deactiveState.path=node.config.path};_proto.draw=function draw(){var node=this,config=node.config,chartConfig=node.getFromEnv("chartConfig"),tooltext=config.showToolTip?getTooltext(config,chartConfig.style.baseFontSize):_lib.BLANKSTRING;var nodeAttr;if(node.config.active){nodeAttr=config.hovered?config.focussedState:config.unfocussed?config.unfocussedState:config.normalState}else{nodeAttr=config.deactiveState}nodeAttr.cursor=_lib.POINTER;node.addGraphicalElement({el:"group",container:{id:"node-container",isParent:true},tooltext:tooltext,component:node,label:"text-path-container",id:"text-path-container",attr:{name:"text-path-container"}});node.addGraphicalElement({el:"path",label:"node",tooltext:tooltext,container:{id:"text-path-container"},attr:nodeAttr,component:node},true);if(config.showLabel){node.addGraphicalElement({el:"text",label:"node-label",container:{id:"text-path-container"},attr:config.labelAttrs,outlineText:!!chartConfig.textOutline,css:{},tooltext:tooltext,component:node},true)}};_proto._manageSpace=function _manageSpace(spaceArguments){var node=this,config=node.config,smartLabel=node.getFromEnv("smartLabel");var oriSize,smartText,spaceRequired;smartLabel.setStyle(config.style);oriSize=smartLabel.getOriSize(config.label);if(!config.showLabel){return 0}if(config.labelPosition===LABEL_POSITION_TANGENTIAL){if(oriSize.width>spaceArguments.maxSpace){smartText=smartLabel.getSmartText(config.label,spaceArguments.maxSpace,oriSize.height);spaceRequired=smartText.width}else{spaceRequired=oriSize.width}}else if(config.labelPosition===LABEL_POSITION_OUTSIDE){spaceRequired=oriSize.height}else{spaceRequired=0}return spaceRequired};_proto.getName=function getName(){return"node"};_proto.getType=function getType(){return"dataset"};return Node}(_componentInterface.SmartRenderer);var _default=Node;exports.default=_default;