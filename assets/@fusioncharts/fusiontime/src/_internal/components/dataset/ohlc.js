import _inheritsLoose from"@babel/runtime/helpers/inheritsLoose";import CandleStick from"./candlestick";import isValidNumber from"@fusioncharts/utils/src/type/is-valid-number";import{defined,pluckNumber}from"@fusioncharts/core/src/lib";import{addDep}from"@fusioncharts/core/src/dependency-manager";import OHLCAnimation from"./ohlc.animation";import safeMin from"@fusioncharts/utils/src/array/safe-min";import extent from"@fusioncharts/utils/src/array/extent";import TimeConverter from"@fusioncharts/utils/src/time-converter";addDep({name:"ohlcAnimation",type:"animationRule",extension:OHLCAnimation});var UNDEF;var tooltipYbuffer=10,DEFAULT_BEAR_STROKE_COLOR="868AC8";var OHLC=function(_CandleStick){_inheritsLoose(OHLC,_CandleStick);function OHLC(){return _CandleStick.apply(this,arguments)||this}var _proto=OHLC.prototype;_proto.__setDefaultConfig=function __setDefaultConfig(){var config=this.config;_CandleStick.prototype.__setDefaultConfig.call(this);config.defaultBearStyle.stroke=DEFAULT_BEAR_STROKE_COLOR;config.defaultBearPredictiveStyle={};config.defaultBullPredictiveStyle={}};_proto._getRelevantInfo=function _getRelevantInfo(index){var config=this.config;return{firstTimeStamp:config.firstTimeStamp,timeStampGap:config.timeStampGap,dataInfo:config.dataInfo,fill:index!==UNDEF&&config.dataInfo[index].groupId==="bull"?config.bullStyle.stroke:config.bearStyle.stroke}};_proto._drawPlot=function _drawPlot(){var dataset=this,config=dataset.config,attr,dataInfo=config.dataInfo,definedBullOpacity=defined(config.bullOpacity),definedBullFillOpacity=defined(config["bull-fill-opacity"]),definedBullStrokeOpacity=defined(config["bull-stroke-opacity"]),predictiveStyleAttributesBull=config.predictiveStyleAttributesBull,definedPredictiveBullOpacity=defined(predictiveStyleAttributesBull.opacity),definedPredictiveBullFillOpacity=defined(predictiveStyleAttributesBull["fill-opacity"]),definedPredictiveBullStrokeOpacity=defined(predictiveStyleAttributesBull["stroke-opacity"]),definedBearOpacity=defined(config.bearOpacity),definedBearFillOpacity=defined(config["bear-fill-opacity"]),definedBearStrokeOpacity=defined(config["bear-stroke-opacity"]),predictiveStyleAttributesBear=config.predictiveStyleAttributesBear,definedPredictiveBearOpacity=defined(predictiveStyleAttributesBear.opacity),definedPredictiveBearFillOpacity=defined(predictiveStyleAttributesBear["fill-opacity"]),definedPredictiveBearStrokeOpacity=defined(predictiveStyleAttributesBear["stroke-opacity"]),attrBaseBull={},attrBaseBear={},attrBase,derivedGroupId="",isDatumPredictive=false,mergePredictiveStylesInDatumGraphics=function mergePredictiveStylesInDatumGraphics(attrBear,attrBull){definedPredictiveBearOpacity&&(attrBear.opacity=predictiveStyleAttributesBear.opacity);definedPredictiveBearFillOpacity&&(attrBear.opacity=predictiveStyleAttributesBear["fill-opacity"]);definedPredictiveBearStrokeOpacity&&(attrBear.opacity=predictiveStyleAttributesBear["stroke-opacity"]);definedPredictiveBullOpacity&&(attrBull.opacity=predictiveStyleAttributesBull.opacity);definedPredictiveBullFillOpacity&&(attrBull.opacity=predictiveStyleAttributesBull["fill-opacity"]);definedPredictiveBullStrokeOpacity&&(attrBull.opacity=predictiveStyleAttributesBull["stroke-opacity"])};definedBullOpacity&&(attrBaseBull.opacity=config.bullOpacity);definedBullFillOpacity&&(attrBaseBull.opacity=config["bull-fill-opacity"]);definedBullStrokeOpacity&&(attrBaseBull.opacity=config["bull-stroke-opacity"]);definedBearOpacity&&(attrBaseBear.opacity=config.bearOpacity);definedBearFillOpacity&&(attrBaseBear.opacity=config["bear-fill-opacity"]);definedBearStrokeOpacity&&(attrBaseBear.opacity=config["bear-stroke-opacity"]);dataInfo.forEach((function(datum,index){if(datum.groupConfig){isDatumPredictive=dataset.isPlotPredictive(datum);derivedGroupId=isDatumPredictive?datum.groupId+"-predictive":datum.groupId;if(isDatumPredictive){mergePredictiveStylesInDatumGraphics(attrBaseBear,attrBaseBull)}attrBase=datum.groupId==="bull"?attrBaseBull:attrBaseBear;if(!!datum.lowStickYEntend+!!datum.highStickYExtend+!!datum.open+!!datum.close>1){if(datum.groupId==="bull"){attr=Object.assign({path:"M"+datum.midX+","+(datum.highStickYExtend||datum.open||datum.close)+",V"+(datum.lowStickYEntend||datum.close||datum.open),"stroke-linecap":"round"},attrBase);datum.style&&Object.assign(attr,datum.style);dataset.addGraphicalElement({el:"path",component:dataset,container:{label:"group",id:"meso-"+derivedGroupId},props:{index:index,dataLength:dataInfo.length},label:"highlow",attr:attr},true)}else{attr=Object.assign({path:"M"+datum.midX+","+(datum.highStickYExtend||datum.close)+",V"+(datum.lowStickYEntend||datum.open),"stroke-linecap":"round"},attrBase);datum.style&&Object.assign(attr,datum.style);dataset.addGraphicalElement({el:"path",component:dataset,container:{label:"group",id:"meso-"+derivedGroupId},props:{index:index,dataLength:dataInfo.length},label:"highlow",attr:attr},true)}}else if(datum.lowStickYEntend||datum.highStickYExtend){attr=Object.assign({path:"M"+datum.midX+","+(datum.lowStickYEntend||datum.highStickYExtend)+",V"+(datum.lowStickYEntend||datum.highStickYExtend),"stroke-linecap":"round"},attrBase);datum.style&&Object.assign(attr,datum.style);dataset.addGraphicalElement({el:"path",component:dataset,container:{label:"group",id:"meso-"+datum.groupId},props:{index:index,dataLength:dataInfo.length},label:"highlow",attr:attr},true)}if(datum.open){attr=Object.assign({path:"M"+datum.midX+","+datum.open+",H"+datum.leftExtend},attrBase);datum.style&&Object.assign(attr,datum.style);dataset.addGraphicalElement({el:"path",component:dataset,container:{label:"group",id:"meso-"+derivedGroupId},props:{index:index,dataLength:dataInfo.length},label:"open",attr:attr},true)}if(datum.close){attr=Object.assign({path:"M"+datum.midX+","+datum.close+",H"+datum.rightExtend},attrBase);datum.style&&Object.assign(attr,datum.style);dataset.addGraphicalElement({el:"path",component:dataset,container:{label:"group",id:"meso-"+derivedGroupId},props:{index:index,dataLength:dataInfo.length},label:"close",attr:attr},true);datum.style=UNDEF}}}));config.hoverInfo=[]};_proto.allocatePosition=function allocatePosition(){var dataset=this,binDecider=dataset.getFromEnv("binDecider"),xScale=dataset.getFromEnv("xScale"),yScale=dataset.getFromEnv("yScale"),config=dataset.config,_config$indices=config.indices,xIdx=_config$indices[0],openIdx=_config$indices[1],highIdx=_config$indices[2],lowIdx=_config$indices[3],closeIdx=_config$indices[4],width,date,midX,open,close,high,low,pX,firstTimeStamp,dataObj,dataInfo=config.dataInfo,dateColumn=dataset.getFromEnv("dateColumn"),isUTC=dataset.getFromEnv("isUTC"),groupId,hoverInfo,lowStickYEntend,highStickYExtend,availableWidth,closePx,openPx,startDate,endDate,data=config.data,format=dateColumn.format,measures=config.measures[0],formatter=isUTC?TimeConverter.utcFormatter(format):TimeConverter.formatter(format),duration,openValueFormatted,highValueFormatted,lowValueFormatted,closeValueFormatted;if(config.repositioningDone=dataset._isRepositioningNeeded()){config.timeStampGap=binDecider.getRangeThreshold()[2];config.availableWidth=availableWidth=xScale.getRangeValue(binDecider.getRangeThreshold()[2])-xScale.getRangeValue(0);width=availableWidth*(1-config.plotSpacePercent/100);dataInfo=config.dataInfo=[];data.forEach((function(datum,index){date=datum[xIdx];midX=xScale.getRangeValue(new Date(date.start),new Date(date.end));open=datum[openIdx];close=datum[closeIdx];high=datum[highIdx];low=datum[lowIdx];duration=date.config.duration;startDate=date.start;endDate=date.end;if(!index){firstTimeStamp=config.firstTimeStamp=date.start}closePx=yScale.getRangeValue(close);openPx=yScale.getRangeValue(open);highStickYExtend=yScale.getRangeValue(high);lowStickYEntend=yScale.getRangeValue(low);if(isValidNumber(openPx)||isValidNumber(closePx)||isValidNumber(highStickYExtend)||isValidNumber(lowStickYEntend)){if(isValidNumber(openPx)&&isValidNumber(closePx)){groupId=open>close?"bear":"bull"}dataObj={startDate:startDate,endDate:endDate};dataObj.rightExtend=midX+width/2;dataObj.leftExtend=dataObj.x=midX-width/2;dataObj.endXPosition=dataObj.x+width;dataObj.y=safeMin([highStickYExtend,openPx,closePx,lowStickYEntend]);dataObj.closeValuePx=yScale.getRangeValue(close);dataObj.width=width;dataObj.close=closePx;dataObj.openValue=open;dataObj.closeValue=close;dataObj.highValue=high;dataObj.lowValue=low;dataObj.value=close;dataObj.open=openPx;dataObj.midX=midX;dataObj.groupId=groupId||"bull";dataObj.lowStickYEntend=lowStickYEntend;dataObj.highStickYExtend=highStickYExtend;openValueFormatted=config.formatterFn({value:open,type:"tooltip",prefix:config.prefix,suffix:config.suffix});closeValueFormatted=config.formatterFn({value:close,type:"tooltip",prefix:config.prefix,suffix:config.suffix});highValueFormatted=config.formatterFn({value:high,type:"tooltip",prefix:config.prefix,suffix:config.suffix});lowValueFormatted=config.formatterFn({value:low,type:"tooltip",prefix:config.prefix,suffix:config.suffix});dataObj.eventArgs={index:index,start:startDate,startText:formatter.format(startDate),end:endDate,endText:formatter.format(endDate),binUnit:duration.Unit,binMultiplier:duration.number,plotType:config.type,timeFormatter:format,aggregation:config.aggregation,measure:measures.close,measureHigh:measures.high,measureLow:measures.low,measureOpen:measures.open,measuresClose:measures.close,binValue:close,binOpen:open,binHigh:high,binLow:low,binClose:close,binValueFomatted:closeValueFormatted,binOpenFormatted:openValueFormatted,binHighFormatted:highValueFormatted,binCloseFormatted:closeValueFormatted,binLowFormatted:lowValueFormatted};var minmax=extent([openPx,closePx,highStickYExtend,lowStickYEntend]);dataObj.height=Math.abs(minmax[0]-minmax[1])||0;dataObj.colY=dataObj.height/2+highStickYExtend-tooltipYbuffer;dataObj["stroke-width"]=pluckNumber(config["default-stroke-width"],1);dataObj.groupConfig=groupId==="bull"?"bullConfig":"bearConfig";pX=xScale.getBinIndex(date.start,firstTimeStamp);dataInfo[pX]=dataObj}}))}if(hoverInfo=config.hoverInfo){hoverInfo.forEach((function(hoveredData){hoveredData.hoverIndices.forEach((function(index){if(typeof dataInfo[index]==="object"){dataInfo[index].style=hoveredData[dataInfo[index].groupId+"Style"]}}))}))}};_proto.getName=function getName(){return"timeseries-ohlc"};return OHLC}(CandleStick);export default OHLC;